{% extends "base.html" %}

{% block title %}Jobs - ADR-Workbench{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Background Jobs</h1>

<div 
    hx-get="/api/jobs"
    hx-trigger="load, every 5s"
    hx-target="#jobs-list"
    class="card"
>
    <div id="jobs-list">
        <p class="text-gray-500">Loading jobs...</p>
    </div>
</div>

<script>
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'jobs-list') {
            const jobs = JSON.parse(event.detail.xhr.response);
            let html = '<div class="space-y-4">';
            
            if (jobs.length === 0) {
                html += '<p class="text-gray-500 text-center">No jobs found</p>';
            } else {
                jobs.forEach(job => {
                    const statusColors = {
                        'pending': 'bg-gray-200 text-gray-800',
                        'running': 'bg-blue-200 text-blue-800',
                        'completed': 'bg-green-200 text-green-800',
                        'failed': 'bg-red-200 text-red-800',
                        'cancelled': 'bg-yellow-200 text-yellow-800'
                    };
                    
                    html += `
                        <div class="border p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="badge ${statusColors[job.status]}">${job.status.toUpperCase()}</span>
                                        <span class="text-sm text-gray-500">Type: ${job.job_type}</span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        Created: ${new Date(job.created_at).toLocaleString()}
                                    </div>
                                    ${job.error_message ? `<div class="text-sm text-red-600 mt-1">Error: ${job.error_message}</div>` : ''}
                                </div>
                                <div>
                                    ${job.status === 'pending' || job.status === 'running' ? 
                                        `<button 
                                            hx-post="/api/jobs/${job.id}/cancel"
                                            hx-confirm="Cancel this job?"
                                            class="text-red-600 hover:underline"
                                        >Cancel</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            event.detail.target.innerHTML = html;
        }
    });
</script>
{% endblock %}
